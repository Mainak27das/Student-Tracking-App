{% extends "base.html" %}
{% block title %}Batch Details{% endblock title %}

{% block body %}
<div class="container py-4">
    <h2 class="text-center text-uppercase mb-4">Batch: {{ batch.subject_name }}</h2>
    
    <!-- Batch Details -->
    <div class="card my-4 shadow-sm border-0">
        <div class="card-body">
            <div class="row">
                <h5 class="card-title col">Batch Day: <span class="text-uppercase text-primary">{{ batch.batch_day }}</span></h5>
                <h5 class="card-title col">Batch Starts: <span class="text">{{ batch.batch_time }}</span></h5>
                <h5 class="card-title col">Batch Ends: <span class="text">{{ batch.batch_duration }}</span></h5>
            </div>
        </div>
    </div>

    <!-- Add Existing Students -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <h5 class="card-title mb-4">Add Existing Students</h5>
            <form method="post" action="{% url 'add_existing_students' batch.id %}">
                {% csrf_token %}
                <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th scope="col">Select</th>
                                <th scope="col">Name</th>
                                <th scope="col">Phone Number</th>
                                <th scope="col">Board</th>
                                <th scope="col">Class</th>
                                <th scope="col">Subject</th>
                                <th scope="col">Payment Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                                <tr>
                                    <td>
                                        <input type="checkbox" name="existing_students" value="{{ student.id }}" 
                                            {% if student in batch.students.all %} 
                                            disabled 
                                            {% endif %}
                                        >
                                    </td>
                                    <td>{{ student.name }}</td>
                                    <td>{{ student.phone_number }}</td>
                                    <td>{{ student.board }}</td>
                                    <td>{{ student.student_class }}</td>
                                    <td>{{ student.subject }}</td>
                                    <td>{{ student.payment }}</td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">No students available.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Add Selected Students</button>
                <button type="button" id="unselectButton" class="btn btn-outline-secondary mt-3">Unselect All</button>
                <button type="button" class="btn btn-success mt-3" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                    Add New Student
                </button>
            </form>
        </div>
    </div>

    <!-- List of Students in the Batch -->
    <h3 class="mt-5">Students in This Batch</h3>
    <div class="card my-4 shadow-sm border-0">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover text-center">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Name</th>
                            <th scope="col">Phone Number</th>
                            <th scope="col">Board</th>
                            <th scope="col">Class</th>
                            <th scope="col">Subject</th>
                            <th scope="col">Payment Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in batch.students.all %}
                        <tr>
                            <td>{{ student.id }}</td>
                            <td>{{ student.name }}</td>
                            <td>{{ student.phone_number }}</td>
                            <td>{{ student.board }}</td>
                            <td>{{ student.student_class }}</td>
                            <td>{{ student.subject }}</td>
                            <td>{{ student.payment }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">No students in this batch.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Modal for Adding New Student -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: rgb(37, 37, 37); color: white;">
                <h5 class="modal-title" id="addStudentModalLabel">Add New Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: white;"></button>
            </div>
            <div class="modal-body" style="background-color: rgb(248, 249, 250);">
                <form method="post" action="{% url 'add_new_student' batch.id %}">
                    {% csrf_token %}
                    <div class="row row-cols-2">
                        <div class="col mb-3">
                            <label for="studentName" class="form-label fw-bold">Student Name:</label>
                            <input type="text" id="studentName" name="name" class="form-control" required>
                        </div>
                        <div class="col mb-3">
                            <label for="studentPhone" class="form-label fw-bold">Phone Number:</label>
                            <input type="text" id="studentPhone" name="phone_number" class="form-control">
                        </div>
                        <div class="col mb-3">
                            <label for="studentBoard" class="form-label fw-bold">Board:</label>
                            <select id="studentBoard" name="board" class="form-select">
                                <option value="CBSE">CBSE</option>
                                <option value="WBBSE">WBBSE</option>
                                <option value="ICSE">ICSE</option>
                            </select>
                        </div>
                        <div class="col mb-3">
                            <label for="studentClass" class="form-label fw-bold">Class:</label>
                            <input type="text" id="studentClass" name="student_class" class="form-control">
                        </div>
                        <div class="col mb-3">
                            <label for="studentPayment" class="form-label fw-bold">Payment Status:</label>
                            <select id="studentPayment" name="payment" class="form-select">
                                <option value="DONE">DONE</option>
                                <option value="NOT DONE">NOT DONE</option>
                            </select>
                        </div>
                        <div class="col mb-3">
                            <label for="studentSubject" class="form-label fw-bold">Subject:</label>
                            <input type="text" id="studentSubject" name="subject" class="form-control" value="{{ batch.subject_name }}" readonly>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-dark btn-lg">Add Student</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Script to Unselect All Options -->
<script>
    document.getElementById('unselectButton').addEventListener('click', function() {
        const selectElement = document.getElementById('existingStudents');
        for (let option of selectElement.options) {
            option.selected = false;
        }
    });
</script>

{% endblock body %}
