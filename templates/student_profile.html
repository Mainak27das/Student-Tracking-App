{% extends "base.html" %}
{% load static %}
{% block title %}Student Profile{% endblock title %}
{% block style %}
    <link rel="stylesheet" href="{% static "css/student_profile.css" %}">
{% endblock style %}
{% block body %}
<div class="container py-5">
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="row mb-4">
                <!-- Left Column: Profile Details -->
                <div class="col-md-6">
                    <h2 class="mb-3">{{ student.name }}</h2>
                    <p class="text-muted">{{ student.get_board_display }} | Class: {{ student.student_class }}</p>
                    <p><strong>Phone Number:</strong> {{ student.phone_number }}</p>
                    <p><strong>Fees:</strong> {{ student.fees }}</p>

                    <button class="btn btn-dark" id="payment-record-dailog">Record Payment</button>
                    <div class="parent-details">
                        {% if parent %}
                            <p class="fahter">Fahter: <strong>{{parent.father_name}}</strong></p>
                            <p class="fahter">'Fahter's Ph. No.': <strong>{{parent.father_phone_number}}</strong></p>
                            <p class="fahter">Mother: <strong>{{parent.mother_name}}</strong></p>
                            <p class="fahter">'Mohter's Ph. No.': <strong>{{parent.mother_phone_number}}</strong></p>
                            
                            <a href="{% url "edit_parent" parent.id student.id %}" class="btn btn-dark" id="payment-record-dailog">Edit Parent Details</a>
                        {% else %}
                            <a href="{% url "add_parent" student.id %}" class="btn btn-dark" id="payment-record-dailog">Add Parent Details</a>
                        {% endif %}
                    </div>
                </div>

                <!-- Right Column: Actions -->
                <div class="col-md-6 text-end align-self-center">
                    <a href="{% url 'edit_student' student.id %}" class="btn btn-primary mb-2 me-2 px-4">Edit</a>
                    <form method="post" action="{% url 'delete_student' student.id %}" class="d-inline-block">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger mb-2 px-4" onclick="return confirm('Are you sure you want to delete this profile?');">Delete</button>
                    </form>
                </div>
            </div>

            {% comment %} Payment Record {% endcomment %}
            <div>
                <h4 class="mb-3">Payment Records</h4>
                <h4 class="mb-3">Total Due : </h4>
                <span class="{% if student.total_due > 0 %} text-danger fw-semibold{% endif %}">{{ student.total_due }}</span>
                {% if payments %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">Amount</th>
                                    <th scope="col">Due</th>
                                    <th scope="col">Payment Method</th>
                                    <th scope="col">Payment Date</th>
                                    <th scope="col">Payment of Months</th>
                                    <th scope="col">Modification</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in payments %}
                                    <tr>
                                        <td>{{ payment.amount }}</td>
                                        <td class="{% if payment.due_amount > 0 %} text-danger {% endif %}">{{ payment.due_amount }}</td>
                                        <td>{{ payment.payment_method }}</td>
                                        <td>{{ payment.date }}</td>
                                        <td><strong>{{payment.year}}: </strong> {{ payment.months }}</td>
                                        <td>{% if payment.modification %}{{payment.modification}}{% endif %}</td>
                                        <td>
                                            <a href="{% url "update_payment" payment.id student.id %}" class="btn btn-primary btn-sm me-2">Edit</a>
                                            <a href="{% url "clear_due" payment.id student.id  %}" class="btn btn-primary btn-sm me-2">Clear Due</a>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No payment record yet.</p>
                {% endif %}
            </div>

            <!-- Enrolled Batches -->
            <div>
                <h4 class="mb-3">Enrolled Batches</h4>
                {% if batches %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">Batch Name</th>
                                    <th scope="col">Subject</th>
                                    <th scope="col">Time</th>
                                    <th scope="col">Day</th>
                                    <th scope="col">Payment</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for batch in batches %}
                                    <tr>
                                        <td>{{ batch.batch_name }}</td>
                                        <td>{{ batch.subject_name }}</td>
                                        <td>{{ batch.batch_time }}</td>
                                        <td>{{ batch.batch_day }}</td>
                                        <td>{{ student.payment }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No batches assigned to this student.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<dialog id="payment-record">
    <div class="content">
        <p class="text text-center fw-bold fs-2">Payment Record</p>
        <form action="{% url "payment_record" student.id %}" method="post" class="mb-3">
            {% csrf_token %}
            <div class="mb-3">
                <label for="payment" class="form-label">Payment Amount</label>
                <input type="number" class="form-control" id="payment" name="payment" required>
            </div>

            <div class="mb-3">
                <label for="payment" class="form-label">Payment Method</label>
                <select class="form-control" id="payment_method" name="payment_method" required>
                    <option value="Cash">Cash</option>
                    <option value="UPI">UPI</option>
                    <option value="Card">Card</option>
                </select>
            </div>


            <div class="mb-3">
                <label for="payment_date" class="form-label">Payment Date</label>
                <input type="date" class="form-control" id="payment_date" name="payment_date" required>
            </div>

            <div class="mb-3">
                <label for="payment_year" class="form-label">Payment of Year</label>
                <input type="number" class="form-control" id="payment_year" name="payment_year" min="2000" max="2100" step="1" required>
            </div>

            <div class="mb-3">
                <label for="payment_months" class="form-label">Payment of Months</label>
                <select class="form-control" id="payment_months" name="payment_months" multiple required>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>

            
            <button type="submit" class="btn btn-primary ">Record Payment</button>

        </form>

        <button class="btn btn-danger text text-center dialog-close" id="close-dialog">Close</button>
    </div>
</dialog>

{% endblock body %}

{% block script %}
    <script src="{% static "js/student_profile.js" %}"></script>
{% endblock script %}